---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
---

<Layout title="Imposta Nuova Password - Private Chef Service" bodyClass="bg-gray-50 text-gray-900">
  <Header transparent={false} />

  <div class="min-h-screen pt-24 pb-16 px-4 sm:px-6 lg:px-8 flex items-center justify-center">
    <div class="w-full max-w-md">
      <div class="bg-white/90 backdrop-blur-sm shadow-xl rounded-2xl p-8 border border-gray-100 animate-fade-in">
        <div class="mb-6 text-center">
          <h1 class="text-2xl font-bold tracking-tight text-gray-900">Imposta Nuova Password</h1>
          <p class="mt-2 text-sm text-gray-500">Scegli una nuova password sicura per il tuo account.</p>
        </div>

        <form class="space-y-4" id="reset-form">
          <div class="space-y-2">
            <label for="password" class="block text-xs font-semibold text-gray-700 tracking-wide">Nuova Password</label>
            <div class="relative">
              <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400">
                <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="3" y="11" width="18" height="10" rx="2" ry="2" />
                  <path d="M7 11V7a5 5 0 0 1 10 0v4" />
                </svg>
              </span>
              <input
                id="password"
                name="password"
                type="password"
                required
                minlength="6"
                class="block w-full rounded-lg border border-gray-300 bg-white pl-10 pr-3 py-2.5 text-sm text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-black focus:border-black transition-all"
                placeholder="Minimo 6 caratteri"
              />
            </div>
          </div>

          <div class="space-y-2">
            <label for="confirm_password" class="block text-xs font-semibold text-gray-700 tracking-wide">Conferma Password</label>
            <div class="relative">
              <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400">
                <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="3" y="11" width="18" height="10" rx="2" ry="2" />
                  <path d="M7 11V7a5 5 0 0 1 10 0v4" />
                </svg>
              </span>
              <input
                id="confirm_password"
                name="confirm_password"
                type="password"
                required
                minlength="6"
                class="block w-full rounded-lg border border-gray-300 bg-white pl-10 pr-3 py-2.5 text-sm text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-black focus:border-black transition-all"
                placeholder="Ripeti la password"
              />
            </div>
          </div>

          <button
            id="reset-submit"
            type="submit"
            class="w-full mt-2 inline-flex items-center justify-center gap-2 rounded-xl bg-black text-white py-3 text-sm font-semibold tracking-wide shadow-lg shadow-black/10 hover:bg-gray-900 active:scale-[0.99] transition-all duration-200"
          >
            <span>Aggiorna Password</span>
          </button>

          <p id="reset-message" class="mt-2 text-sm text-center hidden"></p>
        </form>
      </div>
    </div>
  </div>
</Layout>

<script>
  import { supabase } from '../lib/supabase';

  const form = document.getElementById('reset-form') as HTMLFormElement;
  const passwordInput = document.getElementById('password') as HTMLInputElement;
  const confirmInput = document.getElementById('confirm_password') as HTMLInputElement;
  const submitBtn = document.getElementById('reset-submit') as HTMLButtonElement;
  const messageBox = document.getElementById('reset-message') as HTMLParagraphElement;

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (submitBtn) submitBtn.disabled = true;
    if (messageBox) {
        messageBox.classList.add('hidden');
        messageBox.classList.remove('text-red-500', 'text-green-600');
    }

    const password = passwordInput.value;
    const confirm = confirmInput.value;

    if (password !== confirm) {
        if (messageBox) {
            messageBox.textContent = 'Le password non coincidono.';
            messageBox.classList.add('text-red-500');
            messageBox.classList.remove('hidden');
        }
        submitBtn.disabled = false;
        return;
    }

    try {
        const { error } = await supabase.auth.updateUser({ password: password });

        if (error) throw error;

        if (messageBox) {
            messageBox.textContent = 'Password aggiornata con successo! Reindirizzamento...';
            messageBox.classList.add('text-green-600');
            messageBox.classList.remove('hidden');
        }
        
        setTimeout(() => {
            window.location.href = '/dashboard';
        }, 2000);

    } catch (err: any) {
        if (messageBox) {
            messageBox.textContent = err.message;
            messageBox.classList.add('text-red-500');
            messageBox.classList.remove('hidden');
        }
        submitBtn.disabled = false;
    }
  });

  // Check if we have a session (handled by Supabase implicit flow from magic link)
  supabase.auth.onAuthStateChange(async (event, session) => {
    if (event === 'PASSWORD_RECOVERY') {
      // User is signed in with temporary session, ready to update password
    }
  });
</script>