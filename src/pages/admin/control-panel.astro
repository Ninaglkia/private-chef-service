---
import Layout from '../../layouts/Layout.astro';
import { createClient } from '@supabase/supabase-js';

// Server-side Route Protection
const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
const supabaseAnonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
const accessToken = Astro.cookies.get('sb-access-token')?.value;

if (!accessToken) {
  return Astro.redirect('/login');
}

const supabaseServer = createClient(supabaseUrl, supabaseAnonKey, {
  auth: {
    persistSession: false,
    autoRefreshToken: false,
  }
});

// Verify user
const { data: { user }, error } = await supabaseServer.auth.getUser(accessToken);

if (error || !user) {
   return Astro.redirect('/login');
}

// Check Role
const { data: profile } = await supabaseServer
  .from('profiles')
  .select('role')
  .eq('id', user.id)
  .single();

if (!profile || profile.role !== 'admin') {
  return Astro.redirect('/');
}
---

<Layout title="Admin Control Panel">
  <div class="max-w-6xl mx-auto py-10 px-4 sm:px-6 lg:px-8 space-y-10">
    <h1 class="text-3xl font-semibold text-gray-900 mb-4">Admin Control Panel</h1>

    <section class="space-y-4">
      <h2 class="text-xl font-semibold text-gray-800">Prenotazioni pagate</h2>
      <div id="bookings-list" class="space-y-4"></div>
    </section>

    <section class="space-y-4">
      <h2 class="text-xl font-semibold text-gray-800">Candidature Prenotazioni (Booking)</h2>
      <div id="applications-list" class="space-y-4"></div>
    </section>

    <section class="space-y-4">
      <h2 class="text-xl font-semibold text-gray-800">Nuove Candidature (Lavora con noi)</h2>
      <div id="recruitment-list" class="space-y-4"></div>
    </section>
  </div>
</Layout>

<script>
  import { supabase } from '../../lib/supabase';
  import type { Booking, Profile, ChefBookingApplication, ChefRecruitmentApplication } from '../../lib/supabase';

  async function ensureAdmin() {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) {
      window.location.href = '/login';
      return null;
    }

    const { data: profile } = await supabase
      .from('profiles')
      .select('*')
      .eq('id', user.id)
      .single();

    const p = profile as Profile | null;
    if (!p || p.role !== 'admin') {
      window.location.href = '/';
      return null;
    }

    return { user, profile: p };
  }

  async function loadAdminPanel() {
    const ctx = await ensureAdmin();
    if (!ctx) return;

    const { data: bookings } = await supabase
      .from('bookings')
      .select('*')
      .in('status', ['searching', 'assigned', 'completed'])
      .order('created_at', { ascending: false });

    const bookingsContainer = document.getElementById('bookings-list');
    if (bookingsContainer) {
      bookingsContainer.innerHTML = '';
      if (!bookings || bookings.length === 0) {
        bookingsContainer.innerHTML = '<p class="text-sm text-gray-500">Nessuna prenotazione.</p>';
      } else {
        bookings.forEach((b) => {
          const booking = b as Booking;
          const div = document.createElement('div');
          div.className = 'border border-gray-200 rounded-lg p-4 flex flex-col gap-2';
          div.innerHTML = `
            <div class="flex justify-between items-center">
              <div>
                <p class="font-medium text-gray-900">${booking.city} • ${new Date(booking.start_date).toLocaleDateString()}</p>
                <p class="text-sm text-gray-600">${booking.num_guests} ospiti • Piano ${booking.plan}</p>
                <p class="text-xs text-gray-500">Stato: ${booking.status}</p>
              </div>
              <div class="flex items-center gap-2">
                <input type="text" placeholder="Chef ID" data-booking-id="${booking.id}" class="chef-id-input border border-gray-300 rounded px-2 py-1 text-xs" />
                <button class="assign-btn px-3 py-1 text-xs font-medium text-white bg-gray-900 rounded-md" data-booking-id="${booking.id}">
                  Assegna Chef
                </button>
              </div>
            </div>
          `;
          bookingsContainer.appendChild(div);
        });
      }
    }

    const { data: applications } = await supabase
      .from('chef_applications')
      .select('*')
      .order('created_at', { ascending: false });

    const appsContainer = document.getElementById('applications-list');
    if (appsContainer) {
      appsContainer.innerHTML = '';
      if (!applications || applications.length === 0) {
        appsContainer.innerHTML = '<p class="text-sm text-gray-500">Nessuna candidatura per booking.</p>';
      } else {
        applications.forEach((a) => {
          const app = a as ChefBookingApplication;
          const div = document.createElement('div');
          div.className = 'border border-gray-200 rounded-lg p-4 flex justify-between items-center';
          div.innerHTML = `
            <div>
              <p class="font-medium text-gray-900">Booking: ${app.booking_id}</p>
              <p class="text-sm text-gray-600">Chef: ${app.chef_id}</p>
              <p class="text-xs text-gray-500">Stato: ${app.status}</p>
            </div>
            <div class="flex items-center gap-2">
              <button class="assign-from-app-btn px-3 py-1 text-xs font-medium text-white bg-green-600 rounded-md" data-booking-id="${app.booking_id}" data-chef-id="${app.chef_id}">
                Assegna
              </button>
              <button class="strike-btn px-3 py-1 text-xs font-medium text-white bg-red-600 rounded-md" data-chef-id="${app.chef_id}">
                Strike
              </button>
            </div>
          `;
          appsContainer.appendChild(div);
        });
      }
    }

    // Load Recruitment Applications
    const { data: recruitments } = await supabase
      .from('chef_recruitment_applications')
      .select('*')
      .order('created_at', { ascending: false });

    const recContainer = document.getElementById('recruitment-list');
    if (recContainer) {
        recContainer.innerHTML = '';
        if (!recruitments || recruitments.length === 0) {
            recContainer.innerHTML = '<p class="text-sm text-gray-500">Nessuna nuova candidatura "Lavora con noi".</p>';
        } else {
            recruitments.forEach((r) => {
                const app = r as ChefRecruitmentApplication;
                const div = document.createElement('div');
                div.className = 'border border-gray-200 rounded-lg p-4 flex flex-col gap-3';
                
                let photosHtml = '';
                if (app.photos_urls && app.photos_urls.length > 0) {
                    photosHtml = `<div class="flex gap-2 mt-2 overflow-x-auto pb-2">
                        ${app.photos_urls.map(url => {
                            // Check if it's a JSON details file
                            if (url.endsWith('.json')) {
                                return `<a href="${url}" target="_blank" class="flex items-center justify-center w-16 h-16 bg-gray-100 rounded text-xs text-gray-600 border hover:bg-gray-200" title="Dettagli extra">JSON</a>`;
                            }
                            return `<a href="${url}" target="_blank"><img src="${url}" class="w-16 h-16 object-cover rounded hover:opacity-75 transition" /></a>`;
                        }).join('')}
                    </div>`;
                }

                div.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-bold text-gray-900">${app.first_name} ${app.last_name}</p>
                            <p class="text-sm text-gray-600">${app.email} • ${app.city}</p>
                            <p class="text-xs text-gray-500 mt-1">Stato: <span class="uppercase font-semibold ${app.status === 'approved' ? 'text-green-600' : app.status === 'rejected' ? 'text-red-600' : 'text-yellow-600'}">${app.status}</span></p>
                        </div>
                        <div class="flex gap-2">
                             ${app.cv_url ? `<a href="${app.cv_url}" target="_blank" class="px-3 py-1 text-xs font-medium text-gray-700 bg-gray-100 rounded hover:bg-gray-200">Vedi CV</a>` : ''}
                        </div>
                    </div>
                    ${photosHtml}
                    <div class="flex gap-2 pt-2 border-t border-gray-100 mt-1">
                         <button class="recruitment-action-btn px-3 py-1 text-xs font-medium text-white bg-green-600 rounded hover:bg-green-700" data-id="${app.id}" data-action="approved">Approva</button>
                         <button class="recruitment-action-btn px-3 py-1 text-xs font-medium text-white bg-red-600 rounded hover:bg-red-700" data-id="${app.id}" data-action="rejected">Rifiuta</button>
                    </div>
                `;
                recContainer.appendChild(div);
            });
        }
    }

    document.addEventListener('click', async (e) => {
      const target = e.target as HTMLElement;

      if (target.matches('.recruitment-action-btn')) {
          const id = target.getAttribute('data-id');
          const action = target.getAttribute('data-action');
          if (!id || !action) return;
          
          if (!confirm(`Sei sicuro di voler impostare lo stato a ${action}?`)) return;

          const { error } = await supabase
              .from('chef_recruitment_applications')
              .update({ status: action })
              .eq('id', id);

          if (error) {
              alert(error.message);
          } else {
              loadAdminPanel();
          }
      }

      if (target.matches('.assign-btn')) {
        const bookingId = target.getAttribute('data-booking-id');
        if (!bookingId) return;
        const input = document.querySelector(`.chef-id-input[data-booking-id="${bookingId}"]`) as HTMLInputElement | null;
        const chefId = input?.value.trim();
        if (!chefId) {
          alert('Inserisci un Chef ID');
          return;
        }

        const { error } = await supabase
          .from('bookings')
          .update({ chef_id: chefId, status: 'assigned' })
          .eq('id', bookingId);

        if (error) {
          alert(error.message);
        } else {
          loadAdminPanel();
        }
      }

      if (target.matches('.assign-from-app-btn')) {
        const bookingId = target.getAttribute('data-booking-id');
        const chefId = target.getAttribute('data-chef-id');
        if (!bookingId || !chefId) return;

        const { error } = await supabase
          .from('bookings')
          .update({ chef_id: chefId, status: 'assigned' })
          .eq('id', bookingId);

        if (error) {
          alert(error.message);
        } else {
          loadAdminPanel();
        }
      }

      if (target.matches('.strike-btn')) {
        const chefId = target.getAttribute('data-chef-id');
        if (!chefId) return;

        const { data: chef } = await supabase
          .from('profiles')
          .select('strikes')
          .eq('id', chefId)
          .single();

        const currentStrikes = (chef as Profile | null)?.strikes ?? 0;

        const { error } = await supabase
          .from('profiles')
          .update({ strikes: currentStrikes + 1 })
          .eq('id', chefId);

        if (error) {
          alert(error.message);
        } else {
          loadAdminPanel();
        }
      }
    });
  }

  loadAdminPanel();
</script>

