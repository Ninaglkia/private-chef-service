---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
---

<Layout title="Sign Up - Private Chef Service" bodyClass="bg-gray-50 text-gray-900">
  <Header transparent={false} />

  <div class="min-h-screen pt-20 pb-12 px-4 sm:px-6 lg:px-8 relative overflow-hidden flex flex-col items-center">
    
    <!-- Progress Steps -->
    <div class="w-full max-w-xl mb-12">
      <nav aria-label="Progress">
        <ol role="list" class="flex items-center w-full">
          <!-- Step 1 -->
          <li id="step-nav-1" class="relative flex flex-col items-center cursor-pointer">
            <div class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm bg-black text-white ring-4 ring-gray-50 z-10 transition-all duration-300" id="step-circle-1">1</div>
            <span class="absolute top-12 text-[10px] font-bold uppercase tracking-widest text-black whitespace-nowrap transition-colors duration-300" id="step-text-1">Access</span>
          </li>
          
          <!-- Line 1-2 -->
          <li class="flex-1 h-0.5 bg-gray-200 mx-2 relative rounded-full overflow-hidden">
            <div class="absolute top-0 left-0 h-full bg-black transition-all duration-500 w-0 ease-out" id="progress-bar-1"></div>
          </li>
          
          <!-- Step 2 -->
          <li id="step-nav-2" class="relative flex flex-col items-center cursor-pointer">
            <div class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm bg-white border-2 border-gray-200 text-gray-400 ring-4 ring-gray-50 z-10 transition-all duration-300" id="step-circle-2">2</div>
            <span class="absolute top-12 text-[10px] font-bold uppercase tracking-widest text-gray-400 whitespace-nowrap transition-colors duration-300" id="step-text-2">Role</span>
          </li>

          <!-- Line 2-3 -->
          <li class="flex-1 h-0.5 bg-gray-200 mx-2 relative rounded-full overflow-hidden">
            <div class="absolute top-0 left-0 h-full bg-black transition-all duration-500 w-0 ease-out" id="progress-bar-2"></div>
          </li>

          <!-- Step 3 -->
          <li id="step-nav-3" class="relative flex flex-col items-center cursor-pointer">
            <div class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm bg-white border-2 border-gray-200 text-gray-400 ring-4 ring-gray-50 z-10 transition-all duration-300" id="step-circle-3">3</div>
            <span class="absolute top-12 text-[10px] font-bold uppercase tracking-widest text-gray-400 whitespace-nowrap transition-colors duration-300" id="step-text-3">Details</span>
          </li>
        </ol>
      </nav>
    </div>

    <!-- Main Content Container -->
    <div class="w-full max-w-[520px] bg-white border border-gray-200 rounded-2xl p-6 sm:p-10 shadow-xl relative">
        
      <!-- Save Draft Button (Visible on Step 3) -->
      <button id="save-draft-btn" class="hidden absolute top-4 right-4 text-xs text-gray-500 hover:text-black flex items-center gap-1 transition-colors">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" /></svg>
        Save Draft
      </button>

      <!-- STEP 1: ACCESS -->
      <div id="step-1" class="step-content space-y-8 animate-fade-in">
        <div class="text-center space-y-4">
          <div class="mx-auto w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-6">
             <svg class="w-8 h-8 text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" /></svg>
          </div>
          <h1 class="text-3xl font-bold text-gray-900">Welcome to Private Chef</h1>
          <p class="text-gray-600 leading-relaxed">
            Join our exclusive community. Whether you're looking for an unforgettable culinary experience or you're a professional ready to showcase your talent, you're in the right place.
          </p>
          <p class="text-sm text-gray-500">
            Registration takes less than 3 minutes.
          </p>
        </div>

        <button id="btn-start" class="w-full py-4 bg-black text-white font-bold rounded-xl hover:bg-gray-800 transition-all transform hover:scale-[1.02] shadow-lg flex items-center justify-center gap-2">
          Start Registration
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" /></svg>
        </button>

        <div class="text-center pt-4 border-t border-gray-100">
          <p class="text-sm text-gray-500">
            Already have an account? <a href="/login" class="text-black underline hover:text-gray-700">Log in</a>
          </p>
        </div>
      </div>

      <!-- STEP 2: ROLE SELECTION -->
      <div id="step-2" class="step-content hidden space-y-8 animate-fade-in">
        <div class="text-center">
          <h2 class="text-2xl font-bold text-gray-900 mb-2">Choose your path</h2>
          <p class="text-gray-600">Select how you want to use the platform</p>
        </div>

        <div class="grid grid-cols-1 gap-4">
          <!-- Customer Option -->
          <label class="relative group cursor-pointer">
            <input type="radio" name="role_selection" value="customer" class="peer sr-only" />
            <div class="p-6 rounded-xl border border-gray-200 bg-white peer-checked:border-black peer-checked:ring-1 peer-checked:ring-black hover:border-gray-400 transition-all duration-300 flex items-center gap-4 shadow-sm">
              <div class="w-12 h-12 rounded-full bg-gray-100 peer-checked:bg-black peer-checked:text-white flex items-center justify-center transition-colors text-gray-900">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
              </div>
              <div>
                <h3 class="font-bold text-lg text-gray-900">Customer</h3>
                <p class="text-sm text-gray-500">I want to book a private chef</p>
              </div>
              <div class="ml-auto opacity-0 peer-checked:opacity-100 transition-opacity">
                <svg class="w-6 h-6 text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
              </div>
            </div>
          </label>

          <!-- Chef/Waiter Option -->
          <label class="relative group cursor-pointer">
            <input type="radio" name="role_selection" value="chef" class="peer sr-only" />
            <div class="p-6 rounded-xl border border-gray-200 bg-white peer-checked:border-black peer-checked:ring-1 peer-checked:ring-black hover:border-gray-400 transition-all duration-300 flex items-center gap-4 shadow-sm">
              <div class="w-12 h-12 rounded-full bg-gray-100 peer-checked:bg-black peer-checked:text-white flex items-center justify-center transition-colors text-gray-900">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>
              </div>
              <div>
                <h3 class="font-bold text-lg text-gray-900">Chef / Waiter</h3>
                <p class="text-sm text-gray-500">I offer culinary services</p>
              </div>
              <div class="ml-auto opacity-0 peer-checked:opacity-100 transition-opacity">
                <svg class="w-6 h-6 text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
              </div>
            </div>
          </label>
        </div>

        <div class="flex gap-3 pt-4">
          <button id="btn-back-1" class="w-1/3 py-3 px-4 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 transition-colors font-medium">Back</button>
          <button id="btn-next-2" disabled class="w-2/3 py-3 px-4 bg-black text-white font-bold rounded-lg hover:bg-gray-800 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">Continue</button>
        </div>
      </div>

      <!-- STEP 3: DATA COLLECTION -->
      <div id="step-3" class="step-content hidden space-y-6 animate-fade-in">
        <div class="text-center">
          <h2 class="text-2xl font-bold text-gray-900 mb-2">Your Details</h2>
          <p class="text-gray-600">Complete your profile to get started</p>
        </div>

        <form id="signup-form" class="space-y-4" novalidate>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-xs font-medium text-gray-700 mb-1">First Name *</label>
              <input type="text" name="first_name" required class="w-full bg-white border border-gray-300 rounded-lg px-3 py-2.5 text-gray-900 focus:ring-1 focus:ring-black focus:border-black transition-colors text-sm placeholder-gray-400" placeholder="John" />
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-700 mb-1">Last Name *</label>
              <input type="text" name="last_name" required class="w-full bg-white border border-gray-300 rounded-lg px-3 py-2.5 text-gray-900 focus:ring-1 focus:ring-black focus:border-black transition-colors text-sm placeholder-gray-400" placeholder="Doe" />
            </div>
          </div>

          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Email *</label>
            <input type="email" name="email" required class="w-full bg-white border border-gray-300 rounded-lg px-3 py-2.5 text-gray-900 focus:ring-1 focus:ring-black focus:border-black transition-colors text-sm placeholder-gray-400" placeholder="john@example.com" />
          </div>

          <div>
             <label class="block text-xs font-medium text-gray-700 mb-1">City *</label>
             <input type="text" name="city" required class="w-full bg-white border border-gray-300 rounded-lg px-3 py-2.5 text-gray-900 focus:ring-1 focus:ring-black focus:border-black transition-colors text-sm placeholder-gray-400" placeholder="New York" />
          </div>

          <!-- CHEF ONLY FIELDS -->
          <div id="chef-fields" class="hidden space-y-4 border-t border-gray-200 pt-4 mt-4">
             <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Tax ID (Codice Fiscale) *</label>
                <input type="text" name="tax_id" class="w-full bg-white border border-gray-300 rounded-lg px-3 py-2.5 text-gray-900 focus:ring-1 focus:ring-black focus:border-black transition-colors text-sm placeholder-gray-400" placeholder="Tax ID Number" />
             </div>
             
             <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Upload CV (PDF/DOC) *</label>
                <div class="relative border-2 border-dashed border-gray-300 rounded-lg p-4 hover:bg-gray-50 transition-colors text-center cursor-pointer group">
                   <input type="file" name="cv_file" accept=".pdf,.doc,.docx" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
                   <div class="space-y-1">
                      <svg class="mx-auto h-8 w-8 text-gray-400 group-hover:text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                      <p class="text-xs text-gray-500" id="cv-filename">Click to upload CV</p>
                   </div>
                </div>
             </div>
          </div>

          <div class="border-t border-gray-200 pt-4 mt-4">
             <label class="block text-xs font-medium text-gray-700 mb-2" id="photos-label">Kitchen Photos (Min 3) *</label>
             <p class="text-[10px] text-gray-500 mb-2" id="photos-hint">Upload photos of your domestic kitchen or work environment.</p>
             
             <div class="grid grid-cols-3 gap-2" id="photo-preview-grid">
                <!-- Preview slots or add button -->
                <div class="aspect-square border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center hover:bg-gray-50 cursor-pointer relative">
                   <input type="file" name="photos" multiple accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" id="photos-input" />
                   <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                </div>
             </div>
             <p class="text-xs text-red-500 mt-1 hidden" id="photos-error">Please upload the required number of photos.</p>
          </div>

          <div class="border-t border-gray-200 pt-4 mt-4">
             <label class="block text-xs font-medium text-gray-700 mb-1">Create Password *</label>
             <input type="password" name="password" required minlength="8" class="w-full bg-white border border-gray-300 rounded-lg px-3 py-2.5 text-gray-900 focus:ring-1 focus:ring-black focus:border-black transition-colors text-sm placeholder-gray-400" placeholder="Min. 8 characters" />
          </div>

          <div class="flex items-start gap-2 pt-2">
             <input type="checkbox" id="privacy" name="privacy" required class="mt-1 w-4 h-4 rounded border-gray-300 text-black focus:ring-black bg-white" />
             <label for="privacy" class="text-xs text-gray-600">
               I accept the <a href="/privacy" class="text-black underline">Privacy Policy</a> and consent to the processing of my personal data.
             </label>
          </div>

          <div class="flex gap-3 pt-6">
            <button type="button" id="btn-back-2" class="w-1/3 py-3 px-4 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 transition-colors font-medium">Back</button>
            <button type="submit" id="btn-submit" class="w-2/3 py-3 px-4 bg-black text-white font-bold rounded-lg hover:bg-gray-800 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
              <span>Complete Registration</span>
              <div class="hidden animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full" id="submit-spinner"></div>
            </button>
          </div>
        </form>
      </div>

    </div>
  </div>
</Layout>

<script>
  import { supabase } from '../lib/supabase';

  // State
  let currentStep = 1;
  let maxStepReached = 1;
  let selectedRole = '';
  let draftData = {};

  // Elements
  const steps = {
    1: document.getElementById('step-1'),
    2: document.getElementById('step-2'),
    3: document.getElementById('step-3')
  };
  
  const stepCircles = {
    1: document.getElementById('step-circle-1'),
    2: document.getElementById('step-circle-2'),
    3: document.getElementById('step-circle-3')
  };

  const stepTexts = {
    1: document.getElementById('step-text-1'),
    2: document.getElementById('step-text-2'),
    3: document.getElementById('step-text-3')
  };
  
  const progressBars = {
    1: document.getElementById('progress-bar-1'),
    2: document.getElementById('progress-bar-2')
  };

  const btnStart = document.getElementById('btn-start');
  const btnBack1 = document.getElementById('btn-back-1');
  const btnNext2 = document.getElementById('btn-next-2');
  const btnBack2 = document.getElementById('btn-back-2');
  const roleInputs = document.querySelectorAll('input[name="role_selection"]');
  const chefFields = document.getElementById('chef-fields');
  const photosLabel = document.getElementById('photos-label');
  const photosHint = document.getElementById('photos-hint');
  const photosInput = document.getElementById('photos-input') as HTMLInputElement;
  const cvInput = document.querySelector('input[name="cv_file"]') as HTMLInputElement;
  const cvFilename = document.getElementById('cv-filename');
  const photoPreviewGrid = document.getElementById('photo-preview-grid');
  const signupForm = document.getElementById('signup-form') as HTMLFormElement;
  const btnSubmit = document.getElementById('btn-submit') as HTMLButtonElement;
  const submitSpinner = document.getElementById('submit-spinner');
  const saveDraftBtn = document.getElementById('save-draft-btn');
  const photosError = document.getElementById('photos-error');

  // Load Draft
  function loadDraft() {
    const saved = localStorage.getItem('signup_draft');
    if (saved) {
      try {
        draftData = JSON.parse(saved);
        if (draftData.role) {
            selectedRole = draftData.role;
            const roleInput = document.querySelector(`input[name="role_selection"][value="${selectedRole}"]`) as HTMLInputElement;
            if (roleInput) {
                roleInput.checked = true;
                btnNext2?.removeAttribute('disabled');
            }
        }
      } catch (e) {
        console.error('Error loading draft', e);
      }
    }
  }

  // Navigation
  function goToStep(step) {
    if (step > maxStepReached) maxStepReached = step;

    // Hide all steps
    Object.values(steps).forEach(el => el?.classList.add('hidden'));
    
    // Show current
    steps[step]?.classList.remove('hidden');
    
    // Update indicators
    for (let i = 1; i <= 3; i++) {
        const circle = stepCircles[i];
        const text = stepTexts[i];

        if (i <= step) {
            // Active or Completed
            // Circle: Black bg, white text, no border
            circle?.classList.remove('bg-white', 'text-gray-400', 'border-2', 'border-gray-200');
            circle?.classList.add('bg-black', 'text-white');
            
            // Text: Black
            text?.classList.remove('text-gray-400');
            text?.classList.add('text-black');
        } else {
            // Inactive
            // Circle: White bg, gray text, gray border
            circle?.classList.remove('bg-black', 'text-white');
            circle?.classList.add('bg-white', 'text-gray-400', 'border-2', 'border-gray-200');

            // Text: Gray
            text?.classList.remove('text-black');
            text?.classList.add('text-gray-400');
        }
    }

    // Update Progress Bars
    if (step >= 2) progressBars[1].style.width = '100%';
    else progressBars[1].style.width = '0%';
    
    if (step >= 3) progressBars[2].style.width = '100%';
    else progressBars[2].style.width = '0%';

    // Logic per step
    if (step === 3) {
        setupStep3();
        saveDraftBtn?.classList.remove('hidden');
    } else {
        saveDraftBtn?.classList.add('hidden');
    }

    currentStep = step;
  }

  function setupStep3() {
    const isChef = selectedRole === 'chef';
    
    // Toggle Chef Fields
    if (isChef) {
        chefFields?.classList.remove('hidden');
        const taxInput = chefFields?.querySelector('input[name="tax_id"]');
        if (taxInput) taxInput.setAttribute('required', 'true');
        
        photosLabel!.textContent = 'Professional Photos (Min 5) *';
        photosHint!.textContent = 'Upload photos of your creations and yourself in uniform.';
    } else {
        chefFields?.classList.add('hidden');
        const taxInput = chefFields?.querySelector('input[name="tax_id"]');
        if (taxInput) taxInput.removeAttribute('required');
        
        photosLabel!.textContent = 'Kitchen Photos (Min 3) *';
        photosHint!.textContent = 'Upload photos of your domestic kitchen or work environment.';
    }
  }

  // Events
  btnStart?.addEventListener('click', () => goToStep(2));
  
  // Step Navigation Click Events
  document.getElementById('step-nav-1')?.addEventListener('click', () => {
      if (1 <= maxStepReached) goToStep(1);
  });
  document.getElementById('step-nav-2')?.addEventListener('click', () => {
      if (2 <= maxStepReached) goToStep(2);
  });
  document.getElementById('step-nav-3')?.addEventListener('click', () => {
      // Prevent jumping from step 1 to 3 (skipping 2)
      if (3 <= maxStepReached && currentStep >= 2) goToStep(3);
  });
  btnBack1?.addEventListener('click', () => goToStep(1));
  btnNext2?.addEventListener('click', () => {
    if (selectedRole) {
        // Save role to draft
        draftData.role = selectedRole;
        localStorage.setItem('signup_draft', JSON.stringify(draftData));
        goToStep(3);
    }
  });
  btnBack2?.addEventListener('click', () => goToStep(2));

  // Role Selection
  roleInputs.forEach(input => {
    input.addEventListener('change', (e) => {
        selectedRole = (e.target as HTMLInputElement).value;
        btnNext2?.removeAttribute('disabled');
    });
  });

  // CV File Upload Preview
  cvInput?.addEventListener('change', (e) => {
    const file = (e.target as HTMLInputElement).files?.[0];
    if (file) {
        cvFilename!.textContent = file.name;
    }
  });

  // Photo Upload & Preview
  let selectedPhotos: File[] = [];
  
  photosInput?.addEventListener('change', (e) => {
    const files = (e.target as HTMLInputElement).files;
    if (!files) return;
    
    const newFiles = Array.from(files);
    selectedPhotos = [...selectedPhotos, ...newFiles];
    updatePhotoGrid();
    validatePhotos();
  });

  function updatePhotoGrid() {
    // Clear existing previews (except the add button)
    const previews = photoPreviewGrid?.querySelectorAll('.photo-preview');
    previews?.forEach(p => p.remove());
    
    // Add new previews
    selectedPhotos.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            const div = document.createElement('div');
            div.className = 'photo-preview aspect-square relative rounded-lg overflow-hidden group';
            div.innerHTML = `
                <img src="${e.target?.result}" class="w-full h-full object-cover" />
                <button type="button" data-index="${index}" class="absolute top-1 right-1 bg-black/50 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            `;
            
            div.querySelector('button')?.addEventListener('click', () => {
                selectedPhotos = selectedPhotos.filter((_, i) => i !== index);
                updatePhotoGrid();
                validatePhotos();
            });
            
            photoPreviewGrid?.insertBefore(div, photoPreviewGrid.firstChild);
        };
        reader.readAsDataURL(file);
    });
  }

  function validatePhotos() {
    const minPhotos = selectedRole === 'chef' ? 5 : 3;
    if (selectedPhotos.length < minPhotos) {
        photosError?.classList.remove('hidden');
        return false;
    } else {
        photosError?.classList.add('hidden');
        return true;
    }
  }

  // Save Draft (Manual)
  saveDraftBtn?.addEventListener('click', () => {
    const formData = new FormData(signupForm);
    const data = Object.fromEntries(formData.entries());
    draftData = { ...draftData, ...data, role: selectedRole };
    localStorage.setItem('signup_draft', JSON.stringify(draftData));
    
    // Show temporary success feedback
    const originalText = saveDraftBtn.innerHTML;
    saveDraftBtn.innerHTML = `<span class="text-green-600">Saved!</span>`;
    setTimeout(() => {
        saveDraftBtn.innerHTML = originalText;
    }, 2000);
  });

  // Form Submit
  signupForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    if (!signupForm.checkValidity()) {
        signupForm.reportValidity();
        return;
    }

    if (!validatePhotos()) {
        return;
    }

    // Loading State
    btnSubmit.disabled = true;
    submitSpinner?.classList.remove('hidden');
    
    const formData = new FormData(signupForm);
    const email = formData.get('email') as string;
    const password = formData.get('password') as string;
    const firstName = formData.get('first_name') as string;
    const lastName = formData.get('last_name') as string;
    const city = formData.get('city') as string;
    
    // Here we would typically upload files first to Storage
    // For this demo, we'll proceed with Auth signup
    
    const { data, error } = await supabase.auth.signUp({
        email,
        password,
        options: {
            data: {
                full_name: `${firstName} ${lastName}`,
                role: selectedRole,
                city,
                // Add other fields as metadata
            }
        }
    });

    if (error) {
        alert(error.message);
        btnSubmit.disabled = false;
        submitSpinner?.classList.add('hidden');
    } else {
        // Clear draft
        localStorage.removeItem('signup_draft');
        
        alert('Registration successful! Please check your email to verify your account.');
        window.location.href = '/login';
    }
  });

  // Initialize
  loadDraft();

</script>

<style>
  .animate-fade-in {
    animation: fadeIn 0.3s ease-out;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>
