---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
---

<Layout title="Recupera Password - Private Chef Service" bodyClass="bg-gray-50 text-gray-900">
  <Header transparent={false} />

  <div class="min-h-screen pt-24 pb-16 px-4 sm:px-6 lg:px-8 flex items-center justify-center">
    <div class="w-full max-w-md">
      <div class="bg-white/90 backdrop-blur-sm shadow-xl rounded-2xl p-8 border border-gray-100 animate-fade-in">
        <div class="mb-6 text-center">
          <h1 class="text-2xl font-bold tracking-tight text-gray-900">Password dimenticata?</h1>
          <p class="mt-2 text-sm text-gray-500">Inserisci la tua email per ricevere le istruzioni di reset.</p>
        </div>

        <form class="space-y-4" id="forgot-form">
          <div class="space-y-2">
            <label for="email" class="block text-xs font-semibold text-gray-700 tracking-wide">Email</label>
            <div class="relative">
              <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400">
                <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="3" y="5" width="18" height="14" rx="2" ry="2" />
                  <polyline points="3 7 12 13 21 7" />
                </svg>
              </span>
              <input
                id="email"
                name="email"
                type="email"
                autocomplete="email"
                required
                class="block w-full rounded-lg border border-gray-300 bg-white pl-10 pr-3 py-2.5 text-sm text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-black focus:border-black transition-all"
                placeholder="you@example.com"
              />
            </div>
          </div>

          <button
            id="forgot-submit"
            type="submit"
            class="w-full mt-2 inline-flex items-center justify-center gap-2 rounded-xl bg-black text-white py-3 text-sm font-semibold tracking-wide shadow-lg shadow-black/10 hover:bg-gray-900 active:scale-[0.99] transition-all duration-200"
          >
            <span>Invia istruzioni</span>
          </button>

          <p id="forgot-message" class="mt-2 text-sm text-center hidden"></p>
        </form>

        <p class="mt-6 text-center text-xs text-gray-500">
          Ti sei ricordato la password?
          <a href="/login" class="font-semibold text-gray-900 hover:underline">Accedi</a>
        </p>
      </div>
    </div>
  </div>
</Layout>

<script>
  import { supabase } from '../lib/supabase';

  const form = document.getElementById('forgot-form') as HTMLFormElement;
  const emailInput = document.getElementById('email') as HTMLInputElement;
  const submitBtn = document.getElementById('forgot-submit') as HTMLButtonElement;
  const messageBox = document.getElementById('forgot-message') as HTMLParagraphElement;

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (submitBtn) submitBtn.disabled = true;
    if (messageBox) {
        messageBox.classList.add('hidden');
        messageBox.classList.remove('text-red-500', 'text-green-600');
    }

    const email = emailInput.value.trim();

    try {
        const { error } = await supabase.auth.resetPasswordForEmail(email, {
            redirectTo: `${window.location.origin}/reset-password`,
        });

        if (error) throw error;

        if (messageBox) {
            messageBox.textContent = 'Se l\'email esiste nel nostro sistema, riceverai un link per resettare la password.';
            messageBox.classList.add('text-green-600');
            messageBox.classList.remove('hidden');
        }
        form.reset();

    } catch (err: any) {
        if (messageBox) {
            messageBox.textContent = err.message;
            messageBox.classList.add('text-red-500');
            messageBox.classList.remove('hidden');
        }
    } finally {
        if (submitBtn) submitBtn.disabled = false;
    }
  });
</script>