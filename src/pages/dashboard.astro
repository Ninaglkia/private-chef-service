---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Dashboard - Private Chef Service">
  <div class="max-w-7xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
    
    <!-- Header -->
    <header class="mb-8 flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
      <div class="flex items-center gap-4">
        <a href="/" class="inline-flex items-center gap-3 group">
          <span class="inline-flex h-9 w-9 rounded-full bg-black text-white items-center justify-center shadow-md group-hover:shadow-lg group-hover:scale-[1.03] transition-transform transition-shadow">
            <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
              <path d="M5 11c0-3.5 2.7-6 7-6s7 2.5 7 6" />
              <path d="M7 11h10" />
              <path d="M8 15h8" />
              <path d="M9 19h6" />
            </svg>
          </span>
          <span class="text-xl sm:text-2xl font-semibold tracking-tight text-gray-900 group-hover:text-black">
            Private Chef
          </span>
        </a>
        <div class="hidden sm:flex flex-col">
          <span class="text-xs font-medium uppercase tracking-wide text-gray-400">Area Cliente</span>
          <span class="text-sm text-gray-600" id="user-email">Loading...</span>
        </div>
      </div>
      <div class="flex items-center justify-between sm:justify-end gap-4">
        <div class="sm:hidden flex flex-col text-right">
          <span class="text-sm font-semibold text-gray-900">Dashboard</span>
          <span class="text-xs text-gray-500" id="user-email-mobile">Loading...</span>
        </div>
        <button id="logout-btn" class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 active:bg-gray-100 transition-colors">
          Log Out
        </button>
      </div>
    </header>

    <!-- Content -->
    <div class="bg-white shadow overflow-hidden sm:rounded-lg mb-8">
      <div class="px-4 py-5 sm:px-6">
        <h3 class="text-lg leading-6 font-medium text-gray-900">Your Bookings</h3>
        <p class="mt-1 max-w-2xl text-sm text-gray-500">Manage your private chef reservations.</p>
      </div>
      <div class="border-t border-gray-200 px-4 py-5 sm:p-6" id="booking-section">
        <p class="text-gray-500 text-sm">Loading bookings...</p>
      </div>
    </div>

  </div>
</Layout>

<script>
  import { supabase } from '../lib/supabase';
  import type { Booking, Profile } from '../lib/supabase';

  const userEmailEl = document.getElementById('user-email');
  const userEmailMobileEl = document.getElementById('user-email-mobile');
  const bookingSection = document.getElementById('booking-section');
  const logoutBtn = document.getElementById('logout-btn');

  async function init() {
    // 1. Check Session
    const { data: { user } } = await supabase.auth.getUser();

    if (!user) {
      const rt = encodeURIComponent('/dashboard');
      window.location.href = `/login?returnTo=${rt}`;
      return;
    }

    if (userEmailEl) userEmailEl.textContent = user.email || '';
    if (userEmailMobileEl) userEmailMobileEl.textContent = user.email || '';

    // 2. Check Profile & Role
    const { data: profile } = await supabase
      .from('profiles')
      .select('*')
      .eq('id', user.id)
      .single();

    const p = profile as Profile | null;

    if (p && p.role === 'admin') {
      window.location.href = '/admin/control-panel';
      return;
    }

    // 3. Load Bookings
    loadBookings(user.email!);
  }

  async function loadBookings(email: string) {
    if (!bookingSection) return;

    const { data: bookings, error } = await supabase
      .from('bookings')
      .select('*')
      .eq('customer_email', email)
      .order('created_at', { ascending: false });

    if (error) {
        console.error('Error loading bookings:', error);
        bookingSection.innerHTML = '<p class="text-red-500">Error loading bookings.</p>';
        return;
    }

    if (!bookings || bookings.length === 0) {
        bookingSection.innerHTML = `
            <div class="text-center py-8">
                <p class="text-gray-500 mb-4">You don't have any active bookings.</p>
                <a href="/booking" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-black hover:bg-gray-800 focus:outline-none">
                    Book a Chef
                </a>
            </div>
        `;
        return;
    }

    bookingSection.innerHTML = '';
    const list = document.createElement('div');
    list.className = 'space-y-6';

    for (const b of bookings) {
        const booking = b as Booking;
        
        // Fetch Chef info if assigned
        let chefHtml = '';
        if (booking.chef_id) {
            const { data: chef } = await supabase.from('profiles').select('*').eq('id', booking.chef_id).single();
            const c = chef as Profile;
            chefHtml = `
                <div class="mt-4 flex items-center p-4 bg-gray-50 rounded-lg">
                    <div class="flex-shrink-0 h-10 w-10 rounded-full bg-gray-300 overflow-hidden">
                        ${c.avatar_url ? `<img src="${c.avatar_url}" class="h-full w-full object-cover" />` : ''}
                    </div>
                    <div class="ml-4">
                        <div class="text-sm font-medium text-gray-900">Chef: ${c.full_name}</div>
                        <div class="text-sm text-gray-500">${c.phone || ''}</div>
                    </div>
                </div>
            `;
        } else {
             chefHtml = `
                <div class="mt-4 p-4 bg-yellow-50 border border-yellow-100 rounded-lg">
                    <p class="text-sm text-yellow-800 font-medium">Finding the perfect chef for you...</p>
                </div>
            `;
        }

        const item = document.createElement('div');
        item.className = 'border border-gray-200 rounded-lg p-6';
        item.innerHTML = `
            <div class="flex justify-between items-start">
                <div>
                    <h4 class="text-lg font-bold text-gray-900">${booking.city}</h4>
                    <p class="text-sm text-gray-500">${new Date(booking.start_date).toLocaleDateString()} • ${booking.num_guests} Guests • ${booking.plan.toUpperCase()} Plan</p>
                </div>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                    booking.status === 'completed' ? 'bg-green-100 text-green-800' : 
                    booking.status === 'searching' ? 'bg-yellow-100 text-yellow-800' : 
                    'bg-gray-100 text-gray-800'
                }">
                    ${booking.status.toUpperCase()}
                </span>
            </div>
            ${chefHtml}
        `;
        list.appendChild(item);
    }
    bookingSection.appendChild(list);
  }

  // Logout
  logoutBtn?.addEventListener('click', async () => {
    await supabase.auth.signOut();
    window.location.href = '/login';
  });

  init();
</script>
